<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Faction Attack Logs</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    tr:nth-child(even) { background-color: #fafafa; }
    select, input[type="datetime-local"] { margin: 5px 10px 10px 0; padding: 5px; }
    .bleed { background-color: #ffcccc; }
    .member-bleed { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Faction Attack Logs</h1>

  <!-- Filters -->
  <label for="factionFilter">Filter by Enemy Faction:</label>
  <select id="factionFilter">
    <option value="all">All</option>
    <option value="IRON FORGE HQ">IRON FORGE HQ</option>
    <option value="Mana">Mana</option>
  </select>

  <label for="startDate">Start Date/Time (UTC):</label>
  <input type="datetime-local" id="startDate">

  <label for="endDate">End Date/Time (UTC):</label>
  <input type="datetime-local" id="endDate">

  <p>Total Bleed (respect lost to selected faction): <span id="totalBleed">0</span></p>

  <!-- Member bleed summaries -->
  <div id="memberBleedSummary"></div>

  <table id="attacksTable">
    <thead>
      <tr>
        <th>Attacker</th>
        <th>Defender</th>
        <th>Result</th>
        <th>Respect Gained</th>
        <th>Respect Lost</th>
        <th>Enemy Faction</th>
        <th>Started (UTC)</th>
        <th>Ended (UTC)</th>
      </tr>
    </thead>
    <tbody>
      <!-- Attack rows will go here -->
    </tbody>
  </table>

  <script>
    const members = ['Deviyl', 'Caits'];
    const tableBody = document.querySelector('#attacksTable tbody');
    const factionFilter = document.getElementById('factionFilter');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const totalBleedSpan = document.getElementById('totalBleed');
    const memberBleedSummary = document.getElementById('memberBleedSummary');
    let allRows = [];

    function formatDate(unixTime) {
      if (!unixTime) return '';
      const d = new Date(unixTime * 1000);
      const year = d.getUTCFullYear();
      const month = String(d.getUTCMonth() + 1).padStart(2, '0');
      const day = String(d.getUTCDate()).padStart(2, '0');
      const hours = String(d.getUTCHours()).padStart(2, '0');
      const minutes = String(d.getUTCMinutes()).padStart(2, '0');
      const seconds = String(d.getUTCSeconds()).padStart(2, '0');
      return `${year}-${month}-${day} ${hours}:${minutes}:${seconds} UTC`;
    }

    function utcInputToUnix(inputValue) {
      if (!inputValue) return null;
      const [datePart, timePart] = inputValue.split('T');
      const [year, month, day] = datePart.split('-').map(Number);
      const [hour, minute] = timePart.split(':').map(Number);
      const d = new Date(Date.UTC(year, month - 1, day, hour, minute, 0));
      return Math.floor(d.getTime() / 1000);
    }

    async function loadAttacks() {
      for (const member of members) {
        try {
          const response = await fetch(`./attacks/${member}_attacks.json`);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const data = await response.json();
          if (!Array.isArray(data)) continue;

          for (const attack of data) {
            const attackerName = attack.attacker?.name ?? 'someone';
            const defenderName = attack.defender?.name ?? 'someone';
            const respectGained = attack.respect_gain ?? 0;
            const respectLost = attack.respect_loss ?? 0;
            const attackerFaction = attack.attacker?.faction?.name ?? 'none';

            let enemyFaction = 'none';
            if (attack.attacker?.name === member) {
              enemyFaction = attack.defender?.faction?.name ?? 'none';
            } else if (attack.defender?.name === member) {
              enemyFaction = attackerFaction;
            }

            const result = attack.result || '';
            const startedUTC = formatDate(attack.started);
            const endedUTC = formatDate(attack.ended);

            const row = document.createElement('tr');
            row.dataset.attackerFaction = attackerFaction;
            row.dataset.defender = defenderName;
            row.dataset.respectLost = respectLost;
            row.dataset.enemyFaction = enemyFaction;
            row.dataset.startedUnix = attack.started ?? 0;
            row.dataset.endedUnix = attack.ended ?? 0;

            row.innerHTML = `
              <td>${attackerName}</td>
              <td>${defenderName}</td>
              <td>${result}</td>
              <td>${respectGained}</td>
              <td>${respectLost}</td>
              <td>${enemyFaction}</td>
              <td>${startedUTC}</td>
              <td>${endedUTC}</td>
            `;

            tableBody.appendChild(row);
            allRows.push(row);
          }
        } catch (err) {
          console.error(`Failed to load attacks for ${member}:`, err);
        }
      }
      updateBleed();
    }

    function updateBleed() {
      const selectedFaction = factionFilter.value;
      let totalBleed = 0;
      const perMemberBleed = {};
      members.forEach(m => perMemberBleed[m] = 0);

      const startUnix = utcInputToUnix(startDateInput.value);
      const endUnix = utcInputToUnix(endDateInput.value);

      allRows.forEach(row => {
        let showRow = (selectedFaction === 'all' || row.dataset.enemyFaction === selectedFaction);

        const attackStartTime = Number(row.dataset.startedUnix);
        const attackEndTime = Number(row.dataset.endedUnix);
        if (startUnix !== null && attackEndTime < startUnix) showRow = false;
        if (endUnix !== null && attackStartTime > endUnix) showRow = false;

        row.style.display = showRow ? '' : 'none';

        const isDefenderMember = members.includes(row.dataset.defender);
        const isAttackerFromSelectedFaction = row.dataset.attackerFaction === selectedFaction;
        const respectLost = Number(row.dataset.respectLost);

        if (showRow && isDefenderMember && isAttackerFromSelectedFaction && respectLost > 0) {
          row.classList.add('bleed');
          totalBleed += respectLost;
          perMemberBleed[row.dataset.defender] += respectLost;
        } else {
          row.classList.remove('bleed');
        }
      });

      totalBleedSpan.textContent = totalBleed;

      memberBleedSummary.innerHTML = '';
      members.forEach(member => {
        const div = document.createElement('div');
        div.className = 'member-bleed';
        div.textContent = `${member}: ${perMemberBleed[member]} bleed`;
        memberBleedSummary.appendChild(div);
      });
    }

    factionFilter.addEventListener('change', updateBleed);
    startDateInput.addEventListener('change', updateBleed);
    endDateInput.addEventListener('change', updateBleed);

    loadAttacks();
  </script>
</body>
</html>
