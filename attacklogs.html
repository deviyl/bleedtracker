<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Faction Attack Logs</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
  h1 { margin-bottom: 10px; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
  th, td { padding: 8px; border: 1px solid #ccc; text-align: left; }
  th { background: #eee; }
  .bleed { background-color: #ffcccc !important; }
  #summaryBox { background: #fff; padding: 15px; border: 1px solid #aaa; margin-top: 15px; }
  #summaryBox h2 { margin-top: 0; }
  .summaryRow { margin-bottom: 5px; }
</style>
</head>
<body>

<h1>Faction Attack Logs</h1>

<label>Select Enemy Faction:</label>
<select id="factionFilter">
  <option value="">-- Show All --</option>
  <option value="49319">IRON FORGE HQ</option>
  <option value="8677">Mana</option>
</select>

<br><br>

<label>Start (UTC):</label>
<input type="datetime-local" id="startTime" />

<label>End (UTC):</label>
<input type="datetime-local" id="endTime" />

<button onclick="applyFilters()">Apply Filters</button>

<div id="summaryBox">
  <h2>Member Bleed Summary</h2>
  <div id="summaryContent">Select a faction to see bleed summary.</div>
</div>

<table id="attackTable">
  <thead>
    <tr>
      <th>Time (UTC)</th>
      <th>Attacker</th>
      <th>Attacker Faction</th>
      <th>Defender</th>
      <th>Defender Faction</th>
      <th>Result</th>
      <th>Respect Gain</th>
      <th>Respect Loss</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const members = ["Caits", "Deviyl"];
let allAttacks = {};
let tableBody = document.querySelector("#attackTable tbody");

async function loadAll() {
  for (let name of members) {
    try {
      const res = await fetch(`attacks/${name}_attacks.json`);
      const data = await res.json();
      allAttacks[name] = data;
    } catch (err) {
      console.error("Load error for " + name, err);
      allAttacks[name] = [];
    }
  }
  applyFilters();
}

function formatUTC(ts) {
  return new Date(ts * 1000).toISOString().replace("T", " ").replace(".000Z", " UTC");
}

function applyFilters() {
  const faction = document.getElementById("factionFilter").value;
  const startVal = document.getElementById("startTime").value;
  const endVal = document.getElementById("endTime").value;

  const startTS = startVal ? Date.parse(startVal + "Z") / 1000 : null;
  const endTS = endVal ? Date.parse(endVal + "Z") / 1000 : null;

  tableBody.innerHTML = "";

  let summary = {};
  members.forEach(m => summary[m] = { attacksReceived: 0, respectLost: 0 });

  members.forEach(member => {
    allAttacks[member].forEach(a => {
      const ts = a.ended ?? a.started;

      if (startTS && ts < startTS) return;
      if (endTS && ts > endTS) return;

      let atkName = a.attacker?.name ?? "Someone";
      let defName = a.defender?.name ?? "Someone";
      let atkFaction = a.attacker?.faction?.name ?? "None";
      let atkFactionID = a.attacker?.faction?.id ?? null;
      let defFaction = a.defender?.faction?.name ?? "None";
      let result = a.result ?? "";
      let gain = a.respect_gain ?? 0;
      let loss = a.respect_loss ?? 0;

      let isBleed = false;

      if (faction && atkFactionID == faction) {
        isBleed = true;

        if (a.defender?.name === member) {
          summary[member].attacksReceived += 1;
          summary[member].respectLost += loss;
        }
      }

      const row = document.createElement("tr");
      if (isBleed) row.classList.add("bleed");

      row.innerHTML = `
        <td>${formatUTC(ts)}</td>
        <td>${atkName}</td>
        <td>${atkFaction}</td>
        <td>${defName}</td>
        <td>${defFaction}</td>
        <td>${result}</td>
        <td>${gain}</td>
        <td>${loss}</td>
      `;
      tableBody.appendChild(row);
    });
  });

  updateSummary(summary, faction);
}

function updateSummary(summary, faction) {
  const box = document.getElementById("summaryContent");

  if (!faction) {
    box.innerHTML = "Select a faction to see bleed summary.";
    return;
  }

  let html = "";

  for (let member of members) {
    html += `
      <div class="summaryRow">
        <strong>${member}</strong> â€”
        Attacks Received: ${summary[member].attacksReceived},
        Respect Lost: ${summary[member].respectLost}
      </div>
    `;
  }

  box.innerHTML = html;
}

loadAll();
</script>

</body>
</html>
