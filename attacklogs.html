<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Faction Attack Logs</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Faction Attack Logs</h1>

  <!-- Filters -->
  <label for="factionFilter">Filter by Enemy Faction:</label>
  <select id="factionFilter">
    <option value="all">All</option>
    <option value="IRON FORGE HQ">IRON FORGE HQ</option>
    <option value="Mana">Mana</option>
  </select>

  <label for="startDate">Start Date/Time (UTC):</label>
  <input type="datetime-local" id="startDate">

  <label for="endDate">End Date/Time (UTC):</label>
  <input type="datetime-local" id="endDate">

  <p>
    Total Bleed (respect lost to selected faction): <span id="totalBleed">0</span><br>
    Total Bleed Attacks: <span id="totalBleedAttacks">0</span>
  </p>

  <div id="memberBleedSummary"></div>
  <div id="membersContainer"></div>

  <script>
    const members = ['Deviyl','Caits']; // Keep this hardcoded for now
    const factionFilter = document.getElementById('factionFilter');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const totalBleedSpan = document.getElementById('totalBleed');
    const totalBleedAttacksSpan = document.getElementById('totalBleedAttacks');
    const memberBleedSummary = document.getElementById('memberBleedSummary');
    const membersContainer = document.getElementById('membersContainer');

    let allData = {}; // Will hold JSON per member

    function formatDate(unixTime) {
      if (!unixTime) return '';
      const d = new Date(unixTime * 1000);
      const year = d.getUTCFullYear();
      const month = String(d.getUTCMonth() + 1).padStart(2, '0');
      const day = String(d.getUTCDate()).padStart(2, '0');
      const hours = String(d.getUTCHours()).padStart(2, '0');
      const minutes = String(d.getUTCMinutes()).padStart(2, '0');
      const seconds = String(d.getUTCSeconds()).padStart(2, '0');
      return `${year}-${month}-${day} ${hours}:${minutes}:${seconds} UTC`;
    }

    function utcInputToUnix(inputValue) {
      if (!inputValue) return null;
      const [datePart, timePart] = inputValue.split('T');
      const [year, month, day] = datePart.split('-').map(Number);
      const [hour, minute] = timePart.split(':').map(Number);
      const d = new Date(Date.UTC(year, month - 1, day, hour, minute, 0));
      return Math.floor(d.getTime() / 1000);
    }

    async function loadAllData() {
      for (const member of members) {
        try {
          const response = await fetch(`./attacks/${member}_attacks.json`);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const data = await response.json();
          allData[member] = Array.isArray(data) ? data : [];
        } catch (err) {
          console.error(`Failed to load attacks for ${member}:`, err);
          allData[member] = [];
        }
      }
      renderMembers();
      updateBleed();
    }

    function renderMembers() {
      membersContainer.innerHTML = '';
      for (const member of members) {
        const section = document.createElement('details');
        section.className = 'member-section';
        section.open = true;

        const summary = document.createElement('summary');
        summary.textContent = member;
        section.appendChild(summary);

        const table = document.createElement('table');
        table.innerHTML = `
          <thead>
            <tr>
              <th>Attacker</th>
              <th>Defender</th>
              <th>Result</th>
              <th>Respect Gained</th>
              <th>Respect Lost</th>
              <th>Enemy Faction</th>
              <th>Started (UTC)</th>
              <th>Ended (UTC)</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        section.appendChild(table);
        membersContainer.appendChild(section);
      }
    }

    function updateBleed() {
      const selectedFaction = factionFilter.value;
      const startUnix = utcInputToUnix(startDateInput.value);
      const endUnix = utcInputToUnix(endDateInput.value);

      let totalBleed = 0;
      let totalBleedAttacks = 0;

      memberBleedSummary.innerHTML = '';

      membersContainer.querySelectorAll('.member-section').forEach((section, i) => {
        const member = members[i];
        const tbody = section.querySelector('tbody');
        tbody.innerHTML = '';

        let memberBleed = 0;
        let memberBleedCount = 0;
        let memberOutgoing = 0;
        let memberOutgoingCount = 0;

        allData[member].forEach(attack => {
          const attackerName = attack.attacker?.name ?? 'someone';
          const defenderName = attack.defender?.name ?? 'someone';
          const respectGained = attack.respect_gain ?? 0;
          const respectLost = attack.respect_loss ?? 0;
          const attackerFaction = attack.attacker?.faction?.name ?? 'none';
          const defenderFaction = attack.defender?.faction?.name ?? 'none';
          const startedUnix = attack.started ?? 0;
          const endedUnix = attack.ended ?? 0;

          // Time filter
          if (startUnix && endedUnix < startUnix) return;
          if (endUnix && startedUnix > endUnix) return;

          let enemyFaction = 'none';
          if (attackerName === member) enemyFaction = defenderFaction;
          else if (defenderName === member) enemyFaction = attackerFaction;

          // Faction filter
          if (selectedFaction !== 'all' && enemyFaction !== selectedFaction) return;

          // Append row
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${attackerName}</td>
            <td>${defenderName}</td>
            <td>${attack.result || ''}</td>
            <td>${respectGained}</td>
            <td>${respectLost}</td>
            <td>${enemyFaction}</td>
            <td>${formatDate(startedUnix)}</td>
            <td>${formatDate(endedUnix)}</td>
          `;

          // Check bleed (incoming)
          if (defenderName === member && attackerFaction === selectedFaction && respectLost > 0) {
            row.classList.add('bleed');
            totalBleed += respectLost;
            totalBleedAttacks++;
            memberBleed += respectLost;
            memberBleedCount++;
          }

          // Outgoing totals
          if (attackerName === member && defenderFaction === selectedFaction) {
            memberOutgoing += respectGained;
            memberOutgoingCount++;
          }

          tbody.appendChild(row);
        });

        // Show only if thereâ€™s any bleed or outgoing? (optional)
        section.style.display = tbody.children.length > 0 ? '' : 'none';

        // Member summary
        const div = document.createElement('div');
        div.className = 'member-summary';
        div.textContent = `${member}: ${memberBleed} bleed (${memberBleedCount} attacks) | Outgoing: ${memberOutgoing} respect (${memberOutgoingCount} attacks)`;
        memberBleedSummary.appendChild(div);
      });

      totalBleedSpan.textContent = totalBleed;
      totalBleedAttacksSpan.textContent = totalBleedAttacks;
    }

    factionFilter.addEventListener('change', updateBleed);
    startDateInput.addEventListener('change', updateBleed);
    endDateInput.addEventListener('change', updateBleed);

    loadAllData();
  </script>
</body>
</html>
