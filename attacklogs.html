<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Faction Attack Logs</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    tr:nth-child(even) { background-color: #fafafa; }
    select, input[type="datetime-local"] { margin: 5px 10px 10px 0; padding: 5px; }
    .bleed { background-color: #ffcccc; }
    .member-summary { font-weight: bold; margin-top: 10px; }
    .collapsible { background-color: #eee; cursor: pointer; padding: 10px; border: none; text-align: left; outline: none; font-size: 16px; width: 100%; }
    .active, .collapsible:hover { background-color: #ccc; }
    .content { display: none; overflow: hidden; margin-bottom: 10px; }
  </style>
</head>
<body>
  <h1>Faction Attack Logs</h1>

  <!-- Filters -->
  <label for="factionFilter">Filter by Enemy Faction:</label>
  <select id="factionFilter">
    <option value="all">All</option>
    <option value="IRON FORGE HQ">IRON FORGE HQ</option>
    <option value="Mana">Mana</option>
  </select>

  <label for="startDate">Start Date/Time (UTC):</label>
  <input type="datetime-local" id="startDate">

  <label for="endDate">End Date/Time (UTC):</label>
  <input type="datetime-local" id="endDate">

  <p>
    Total Bleed (respect lost to selected faction): <span id="totalBleed">0</span><br>
    Total Bleed Attacks: <span id="totalBleedAttacks">0</span><br>
    Total Outgoing Attacks to Selected Faction: <span id="totalOutgoingAttacks">0</span><br>
    Total Respect Gained from Selected Faction: <span id="totalRespectGained">0</span>
  </p>

  <!-- Member summaries and collapsible sections -->
  <div id="memberSections"></div>

  <script>
    const attacksDir = './attacks/';
    const factionFilter = document.getElementById('factionFilter');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const totalBleedSpan = document.getElementById('totalBleed');
    const totalBleedAttacksSpan = document.getElementById('totalBleedAttacks');
    const totalOutgoingAttacksSpan = document.getElementById('totalOutgoingAttacks');
    const totalRespectGainedSpan = document.getElementById('totalRespectGained');
    const memberSectionsDiv = document.getElementById('memberSections');

    let members = [];
    let allAttacksByMember = {};

    function formatDate(unixTime) {
      if (!unixTime) return '';
      const d = new Date(unixTime * 1000);
      const year = d.getUTCFullYear();
      const month = String(d.getUTCMonth() + 1).padStart(2, '0');
      const day = String(d.getUTCDate()).padStart(2, '0');
      const hours = String(d.getUTCHours()).padStart(2, '0');
      const minutes = String(d.getUTCMinutes()).padStart(2, '0');
      const seconds = String(d.getUTCSeconds()).padStart(2, '0');
      return `${year}-${month}-${day} ${hours}:${minutes}:${seconds} UTC`;
    }

    function utcInputToUnix(inputValue) {
      if (!inputValue) return null;
      const [datePart, timePart] = inputValue.split('T');
      const [year, month, day] = datePart.split('-').map(Number);
      const [hour, minute] = timePart.split(':').map(Number);
      const d = new Date(Date.UTC(year, month - 1, day, hour, minute, 0));
      return Math.floor(d.getTime() / 1000);
    }

    async function loadAllMembers() {
      // Fetch the list of attack files
      const response = await fetch(attacksDir);
      if (!response.ok) {
        console.error('Failed to list attacks directory');
        return;
      }

      // This will be simulated since GitHub Pages doesn't allow directory listing
      // We'll hardcode members based on known json files
      members = ['Deviyl', 'Caits']; // If dynamic fetching is needed, use a server-side approach
      for (const member of members) {
        try {
          const res = await fetch(`${attacksDir}${member}_attacks.json`);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          if (!Array.isArray(data)) continue;
          allAttacksByMember[member] = data;
        } catch (err) {
          console.error(`Failed to load attacks for ${member}:`, err);
        }
      }
      updateDisplay();
    }

    function updateDisplay() {
      const selectedFaction = factionFilter.value;
      const startUnix = utcInputToUnix(startDateInput.value);
      const endUnix = utcInputToUnix(endDateInput.value);

      let totalBleed = 0;
      let totalBleedAttacks = 0;
      let totalOutgoingAttacks = 0;
      let totalRespectGained = 0;

      memberSectionsDiv.innerHTML = '';

      members.forEach(member => {
        const memberAttacks = allAttacksByMember[member] || [];
        let memberBleed = 0;
        let memberBleedCount = 0;
        let memberOutgoingCount = 0;
        let memberRespectGained = 0;

        const filteredAttacks = memberAttacks.filter(attack => {
          const attackerName = attack.attacker?.name ?? 'someone';
          const defenderName = attack.defender?.name ?? 'someone';
          const attackerFaction = attack.attacker?.faction?.name ?? 'none';
          const defenderFaction = attack.defender?.faction?.name ?? 'none';
          const respectLost = attack.respect_loss ?? 0;
          const respectGained = attack.respect_gain ?? 0;
          const started = attack.started ?? 0;
          const ended = attack.ended ?? 0;

          if (startUnix !== null && ended < startUnix) return false;
          if (endUnix !== null && started > endUnix) return false;

          // Determine enemy faction relative to member
          let enemyFaction = 'none';
          if (attackerName === member) {
            enemyFaction = defenderFaction;
          } else if (defenderName === member) {
            enemyFaction = attackerFaction;
          }

          // Filter by selected faction
          if (selectedFaction !== 'all' && enemyFaction !== selectedFaction) return false;

          // Count bleed (defender taking damage from selected faction)
          if (defenderName === member && attackerFaction === selectedFaction && respectLost > 0) {
            memberBleed += respectLost;
            memberBleedCount++;
            totalBleed += respectLost;
            totalBleedAttacks++;
          }

          // Count outgoing attacks (member attacking selected faction)
          if (attackerName === member && defenderFaction === selectedFaction) {
            memberOutgoingCount++;
            memberRespectGained += respectGained;
            totalOutgoingAttacks++;
            totalRespectGained += respectGained;
          }

          attack.enemyFaction = enemyFaction;
          attack.attackerName = attackerName;
          attack.defenderName = defenderName;
          attack.startedUTC = formatDate(started);
          attack.endedUTC = formatDate(ended);
          attack.isBleed = (defenderName === member && attackerFaction === selectedFaction && respectLost > 0);

          return true;
        });

        if (filteredAttacks.length === 0) return;

        // Member summary header
        const collBtn = document.createElement('button');
        collBtn.className = 'collapsible';
        collBtn.textContent = `${member} - Bleed: ${memberBleed} (${memberBleedCount} attacks) | Outgoing: ${memberOutgoingCount} attacks, Respect Gained: ${memberRespectGained}`;
        memberSectionsDiv.appendChild(collBtn);

        const contentDiv = document.createElement('div');
        contentDiv.className = 'content';
        const table = document.createElement('table');
        table.innerHTML = `
          <thead>
            <tr>
              <th>Attacker</th>
              <th>Defender</th>
              <th>Result</th>
              <th>Respect Gained</th>
              <th>Respect Lost</th>
              <th>Enemy Faction</th>
              <th>Started (UTC)</th>
              <th>Ended (UTC)</th>
            </tr>
          </thead>
          <tbody>
            ${filteredAttacks.map(a => `
              <tr class="${a.isBleed ? 'bleed' : ''}">
                <td>${a.attackerName}</td>
                <td>${a.defenderName}</td>
                <td>${a.result ?? ''}</td>
                <td>${a.respect_gain ?? 0}</td>
                <td>${a.respect_loss ?? 0}</td>
                <td>${a.enemyFaction}</td>
                <td>${a.startedUTC}</td>
                <td>${a.endedUTC}</td>
              </tr>
            `).join('')}
          </tbody>
        `;
        contentDiv.appendChild(table);
        memberSectionsDiv.appendChild(contentDiv);
      });

      totalBleedSpan.textContent = totalBleed;
      totalBleedAttacksSpan.textContent = totalBleedAttacks;
      totalOutgoingAttacksSpan.textContent = totalOutgoingAttacks;
      totalRespectGainedSpan.textContent = totalRespectGained;

      // Setup collapsibles
      const coll = document.getElementsByClassName('collapsible');
      for (let i = 0; i < coll.length; i++) {
        coll[i].onclick = function() {
          this.classList.toggle('active');
          const content = this.nextElementSibling;
          content.style.display = content.style.display === 'block' ? 'none' : 'block';
        };
      }
    }

    factionFilter.addEventListener('change', updateDisplay);
    startDateInput.addEventListener('change', updateDisplay);
    endDateInput.addEventListener('change', updateDisplay);

    loadAllMembers();
  </script>
</body>
</html>
